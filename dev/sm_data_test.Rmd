---
title: "SurveyMonkey Data Test"
author: "ZC"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk[["set"]](
    echo = FALSE, 
    fig.width = 8,
    fig.height = 6
    )

# Prevents sci notation and sets the output of decimals to 4 (0.0000):
options(scipen = 999, digits = 4)

# Load Libraries:
library(readr)
library(dplyr)
library(bre) # blackstone R package
```


### How to read in .csv data from SurveyMonkey to create nice variable names:
```{r load in .csv data example}
# Read in the pre fake data data:
pre_data_names <- readr::read_csv("sm_data/fake_sm_pre.csv", col_names = FALSE, show_col_types = FALSE) %>% slice(1:2) %>%  # read in the first two lines of the .csv file
    mutate(type = c('question_name', 'full_text')) %>% # name first line 'question_name', and second line 'full_text'
    tidyr::pivot_longer(!type) |> 
    tidyr::pivot_wider(names_from = type, values_from = value) |> 
    select(!name) %>% 
    mutate(full_text = case_when(full_text == "Response" | full_text == "Open-Ended Response" ~ NA_character_, TRUE ~ full_text), # turn "Response" to NA
           full_question_text = coalesce(full_text, question_name), # combine two columns into new col, take first non-missing
           variable_name = janitor::make_clean_names(full_question_text)) # create variable_name col

# createCodebook() takes one argument, `file_path` = file path of the data from SM to be read in, creates a partial codebook 
#   that can be edited to create useful variable names from SM data.
createCodebook <- function(file_path) {
    codebook <- readr::read_csv(file_path, col_names = FALSE, show_col_types = FALSE) %>% slice(1:2) %>%  
                mutate(type = c('question_name', 'full_text')) %>% 
                tidyr::pivot_longer(!type) |> 
                tidyr::pivot_wider(names_from = type, values_from = value) |> 
                select(!name) %>% 
                mutate(full_text = case_when(full_text == "Response" | full_text == "Open-Ended Response" ~ NA_character_, TRUE ~ full_text), # turn "Response" to NA
                       full_question_text = coalesce(full_text, question_name), # combine two columns into new col, take first non-missing, full_text, then question_name
                       variable_name = janitor::make_clean_names(full_question_text)) # make `variable_name` by cleaning names of new col `full_question_text`
    return(codebook)
}
pre_data_names <- createCodebook("sm_data/fake_sm_pre.csv")
# pre_data_names

# Write out codebook, need to go in and edit the column named `variable_name` manually:
# write_csv(pre_data_names, file = "sm_data/fake_codebook.csv")
# variable_name <- c("respondent_id", "collector_id", "start_date", "end_date", "ip_address", "email_address", "first_name", "last_name", "unique_id", "knowledge", 
#                    "research_1", "research_2", "research_3", "research_4", "research_5", "research_6", "research_7", "research_8", 
#                    "ability_1", "ability_2", "ability_3", "ability_4", "ability_5", "ability_6", 
#                    "gender", "ethnicity", "first_gen")

# read in codebook
codebook_pre <- readr::read_csv("sm_data/fake_codebook.csv", show_col_types = FALSE)

# pre_data <- readr::read_csv("sm_data/fake_sm_pre.csv", skip = 2, col_names = FALSE, show_col_types = FALSE) 
# names(pre_data) <- codebook[["variable_name"]]

# sm_names <- readr::read_csv("sm_data/fake_sm_pre.csv", col_names = FALSE, show_col_types = FALSE) %>% slice(1:2) %>%  
#                 mutate(type = c('question_name', 'full_text')) %>% 
#                 tidyr::pivot_longer(!type) |> 
#                 tidyr::pivot_wider(names_from = type, values_from = value) |> 
#                 select(!name) %>% 
#                 mutate(full_text = case_when(full_text == "Response" | full_text == "Open-Ended Response" ~ NA_character_, TRUE ~ full_text), # turn "Response" to NA
#                        full_question_text = coalesce(full_text, question_name)) %>%  # combine two columns into new col, take first non-missing, full_text, then question_name
#                 select(full_question_text) %>% 
#                 tibble::deframe()
# 
# sm_data_new <- readr::read_csv("sm_data/fake_sm_pre.csv", skip = 2, col_names = FALSE, show_col_types = FALSE) 
# names(sm_data_new) <- sm_names
# # Creat a named vector of the columns 
# sm_new_names <- codebook_pre %>% select(variable_name, full_question_text) %>% tibble::deframe()
# # use it to rename the vars:
# sm_data_new <- sm_data_new %>% rename(any_of(sm_new_names))
# sm_data_new
# renameData() takes two argument, `file_path` = file path of the data from SM to be read in and `codebook` = tibble of codebook from createCodebook() with column named `variable_name`, 
# Reads in the SM data with new variable names taken from the codebook df column named `variable_name`.
readRenameCSV <- function(file_path, codebook) {
    # Condense the two header rows into one row set as a character vector:
    sm_names <- readr::read_csv(file_path, col_names = FALSE, show_col_types = FALSE) %>% slice(1:2) %>%  
                mutate(type = c('question_name', 'full_text')) %>% 
                tidyr::pivot_longer(!type) |> 
                tidyr::pivot_wider(names_from = type, values_from = value) |> 
                select(!name) %>% 
                mutate(full_text = case_when(full_text == "Response" | full_text == "Open-Ended Response" ~ NA_character_, TRUE ~ full_text), # turn "Response" to NA
                       full_question_text = coalesce(full_text, question_name)) %>%  # combine two columns into new col, take first non-missing, full_text, then question_name
                select(full_question_text) %>% 
                tibble::deframe()
    # Read in the data and set names as vector `sm_names`
    sm_data <- readr::read_csv("sm_data/fake_sm_pre.csv", skip = 2, col_names = FALSE, show_col_types = FALSE) 
    names(sm_data) <- sm_names
    
    # Create a named vector of the columns from `codebook` named `variable_name` and `full_question_text` where `variable_name` is the names, will be new names in data:
    sm_new_names <- {{ codebook }} %>% select(variable_name, full_question_text) %>% tibble::deframe()
    
    # use it to rename the vars in `sm_data` so they match:
    sm_data <- sm_data %>% rename(any_of(sm_new_names))
    sm_data
    
    return(sm_data)
}
pre_data <- renameData("sm_data/fake_sm_pre.csv", codebook = codebook_pre)
pre_data
# Read in the post fake data:
# post_data <- readr::read_csv("sm_data/fake_sm_post.csv")

```
