---
title: "SurveyMonkey Data Test"
author: "ZC"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk[["set"]](
    echo = FALSE, 
    fig.width = 8,
    fig.height = 6
    )

# Prevents sci notation and sets the output of decimals to 4 (0.0000):
options(scipen = 999, digits = 4)

# Load Libraries:
library(readr)
library(dplyr)
library(bre) # blackstone R package
```


### How to read in .csv data from SurveyMonkey to create nice variable names:
```{r load in .csv data example}
# Read in the pre fake data data:
# pre_data_names <- readr::read_csv("sm_data/fake_sm_pre.csv", col_names = FALSE, show_col_types = FALSE) %>% slice(1:2) %>%  # read in the first two lines of the .csv file
#     mutate(type = c('question_name', 'full_text')) %>% # name first line 'question_name', and second line 'full_text'
#     tidyr::pivot_longer(!type) |> 
#     tidyr::pivot_wider(names_from = type, values_from = value) |> 
#     select(!name) %>% 
#     mutate(full_text = case_when(full_text == "Response" | full_text == "Open-Ended Response" ~ NA_character_, TRUE ~ full_text), # turn "Response" to NA
#            full_question_text = coalesce(full_text, question_name), # combine two columns into new col, take first non-missing
#            variable_name = janitor::make_clean_names(full_question_text)) # create variable_name col

# createCodebook() takes one argument, `file_path` = file path of the data from SM to be read in, creates a partial codebook 
#   that can be edited to create useful variable names from SM data.
createCodebook <- function(file_path) {
    codebook <- readr::read_csv(file_path, col_names = FALSE, show_col_types = FALSE) %>% slice(1:2) %>%  
                mutate(type = c('question_name', 'full_text')) %>% 
                tidyr::pivot_longer(!type) |> 
                tidyr::pivot_wider(names_from = type, values_from = value) |> 
                select(!name) %>% 
                mutate(full_text = case_when(full_text == "Response" | full_text == "Open-Ended Response" ~ NA_character_, TRUE ~ full_text), # turn "Response" to NA
                       full_question_text = coalesce(full_text, question_name), # combine two columns into new col, take first non-missing, full_text, then question_name
                       variable_name = janitor::make_clean_names(full_question_text)) # make `variable_name` by cleaning names of new col `full_question_text`
    return(codebook)
}
pre_data_names <- createCodebook("sm_data/fake_sm_pre.csv")
# pre_data_names

# Write out codebook, need to go in and edit the column named `variable_name` manually:
# write_csv(pre_data_names, file = "sm_data/fake_codebook.csv")
# variable_name <- c("respondent_id", "collector_id", "start_date", "end_date", "ip_address", "email_address", "first_name", "last_name", "unique_id", "knowledge", 
#                    "research_1", "research_2", "research_3", "research_4", "research_5", "research_6", "research_7", "research_8", 
#                    "ability_1", "ability_2", "ability_3", "ability_4", "ability_5", "ability_6", 
#                    "gender", "ethnicity", "first_gen")

# read in codebook
codebook_pre <- readr::read_csv("sm_data/fake_codebook.csv", show_col_types = FALSE)

# pre_data <- readr::read_csv("sm_data/fake_sm_pre.csv", skip = 2, col_names = FALSE, show_col_types = FALSE) 
# names(pre_data) <- codebook[["variable_name"]]

# sm_names <- readr::read_csv("sm_data/fake_sm_pre.csv", col_names = FALSE, show_col_types = FALSE) %>% slice(1:2) %>%  
#                 mutate(type = c('question_name', 'full_text')) %>% 
#                 tidyr::pivot_longer(!type) |> 
#                 tidyr::pivot_wider(names_from = type, values_from = value) |> 
#                 select(!name) %>% 
#                 mutate(full_text = case_when(full_text == "Response" | full_text == "Open-Ended Response" ~ NA_character_, TRUE ~ full_text), # turn "Response" to NA
#                        full_question_text = coalesce(full_text, question_name)) %>%  # combine two columns into new col, take first non-missing, full_text, then question_name
#                 select(full_question_text) %>% 
#                 tibble::deframe()
# 
# sm_data_new <- readr::read_csv("sm_data/fake_sm_pre.csv", skip = 2, col_names = FALSE, show_col_types = FALSE) 
# names(sm_data_new) <- sm_names
# # Creat a named vector of the columns 
# sm_new_names <- codebook_pre %>% select(variable_name, full_question_text) %>% tibble::deframe()
# # use it to rename the vars:
# sm_data_new <- sm_data_new %>% rename(any_of(sm_new_names))
# sm_data_new
# renameData() takes two argument, `file_path` = file path of the data from SM to be read in and `codebook` = tibble of codebook from createCodebook() with column named `variable_name`, 
# Reads in the SM data with new variable names taken from the codebook df column named `variable_name`.
readRenameData <- function(file_path, codebook) {
    # TODO: add functionality for excel data files.
    # Get file path extension, then use that to load .csv or .xlsx:
    ext <- tools::file_ext(file_path)
    sm_data_headers <- switch(ext,
                              csv = readr::read_csv(file_path, col_names = FALSE, show_col_types = FALSE),
                              xlsx = readxl::read_xlsx(file_path, col_names = FALSE, show_col_types = FALSE),
                              # Return an error message if file is not .csx or .xlsx:
                              warning("Invalid file! Please upload a .csv or .xlsx file")
                              )
    # Using `sm_data_headers`- Condense the two header rows into one row and set as a character vector:
    sm_names <- sm_data_headers %>% dplyr::slice(1:2) %>%  
                dplyr::mutate(type = c('question_name', 'full_text')) %>% 
                tidyr::pivot_longer(!type) |> 
                tidyr::pivot_wider(names_from = type, values_from = value) |> 
                dplyr::select(!name) %>% 
                dplyr::mutate(full_text = dplyr::case_when(full_text == "Response" | full_text == "Open-Ended Response" ~ NA_character_, TRUE ~ full_text), # turn "Response" to NA
                       full_question_text = dplyr::coalesce(full_text, question_name)) %>%  # combine two columns into new col, take first non-missing, full_text, then question_name
                dplyr::select(full_question_text) %>% 
                tibble::deframe()
    # Read in the data, using switch with ext from above, skipping first 2 lines, and then set names using the vector `sm_names`:
    sm_data <- switch(ext,
                      csv = readr::read_csv(file_path, skip = 2, col_names = FALSE, show_col_types = FALSE),
                      xlsx = readxl::read_xlsx(file_path, skip = 2, col_names = FALSE, show_col_types = FALSE),
                      # Return an error message if file is not .csx or .xlsx:
                      warning("Invalid file! Please upload a .csv or .xlsx file")
                      ) %>% 
                purrr::set_names(sm_names) 
    # names(sm_data) <- sm_names
    
    # Create a named vector of the columns from `codebook` named `variable_name` and `full_question_text` where `variable_name` is the names and 
    # will be the new names in data:
    sm_new_names <- {{ codebook }} %>% dplyr::select(variable_name, full_question_text) %>% tibble::deframe()
    
    # use it to rename the vars in `sm_data` so they match:
    sm_data <- sm_data %>% dplyr::rename(tidyselect::any_of(sm_new_names))
    sm_data
    
    return(sm_data)
}
pre_data <- readRenameData("sm_data/fake_sm_pre.csv", codebook = codebook_pre)
pre_data
# Read in the post fake data:
# post_data <- readr::read_csv("sm_data/fake_sm_post.csv")

```
### Test on fake post data:
```{r}
post_data_fp <- "sm_data/fake_sm_post.csv"
# 1. Create and edit the codebook:
codebook_post <- createCodebook(post_data_fp)

# Create names as vectors:
research_names <- purrr::map_chr(1:8, \(x) paste0("research_",x))
ability_names <- purrr::map_chr(1:6, \(x) paste0("ability_",x))

# Create old Names as vectors:
research_vals <- c("research_relevant_background_literature", "identify_a_scientific_problem", "develop_testable_and_realistic_research_questions", "develop_a_falsifiable_hypothesis", 
                   "conduct_quantitative_data_analysis", "design_an_experiment_create_a_research_design", "interpret_findings_and_making_recommendations", "scientific_or_technical_writing")
ability_vals <- c("judge_the_value_of_new_information_or_evidence_presented_to_me", "approach_complex_issues_in_a_variety_of_ways", "weigh_both_sides_of_an_argument", 
                  "identify_analogies_between_theories", "eliminate_extraneous_variables_when_designing_experiments", "rephrase_the_arguments_of_others_in_my_own_words")
# Use replace and case_when to change all variable names, inside replace, select the old names using the _vals vectors and replace with the _names vectors:
codebook_post <- codebook_post %>% mutate(variable_name = replace(variable_name, variable_name %in% research_vals, research_names),
                                          variable_name = replace(variable_name, variable_name %in% ability_vals, ability_names),
                                          variable_name = case_match(variable_name,
                                                                     'custom_data_1' ~ "unique_id",
                                                                     'to_what_extent_are_you_knowledgeable_in_conducting_research_in_your_field_of_study' ~ "knowledge",
                                                                     'with_which_gender_do_you_most_closely_identify' ~ "gender",                                     
                                                                     'which_race_ethnicity_best_describes_you_please_choose_only_one' ~ "ethnicity",                   
                                                                     'are_you_a_first_generation_college_student' ~ "first_gen",
                                                                     .default = variable_name) # returns default value of the original variable 11:18
                                          )
                         
# 2. Write out codebook, need to go in and edit the column named `variable_name` manually:
readr::write_csv(codebook_post, file = "sm_data/fake_codebook_post.csv")

# 3. edit the variable_name column: either in excel or using R: 
codebook_post <- readr::read_csv("sm_data/fake_codebook_post.csv", show_col_types = FALSE)
# 4. Read in the data and rename the vars using readRenameData(), passing the file path and the codebook as a tibble:
post_data <- readRenameData(post_data_fp, codebook = codebook_post)
post_data
```

